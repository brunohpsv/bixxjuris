<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIXXJURIS - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            FacebookAuthProvider,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBPFI-8FJJ2ACpxZhYcjW3ol9CBJzT_hAA",
            authDomain: "bixxjuris.firebaseapp.com",
            projectId: "bixxjuris",
            storageBucket: "bixxjuris.firebasestorage.app",
            messagingSenderId: "560618621657",
            appId: "1:560618621657:web:80aa9231e2b379473dccc8",
            measurementId: "G-WKZS0ZCKHC"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Tornar disponível globalmente
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        
        // Disponibilizar funções
        window.firebase = {
            auth: {
                getAuth: () => auth,
                signInWithEmailAndPassword,
                createUserWithEmailAndPassword,
                onAuthStateChanged,
                GoogleAuthProvider,
                signInWithPopup,
                FacebookAuthProvider,
                updateProfile
            },
            firestore: {
                getFirestore: () => db,
                doc,
                getDoc,
                setDoc
            }
        };

        console.log('Firebase inicializado com sucesso!');
    </script>

    <style>
        /* Variáveis CSS para cores */
        :root {
            --primary: #1E3A8A;
            --secondary: #16A34A;
            --neutral: #6B7280;
            --accent: #F97316;
            --light: #F9FAFB;
            --dark: #1F2937;
            --danger: #EF4444;
            --warning: #F59E0B;
        }

        /* Reset e estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        /* Login e Cadastro */
        .auth-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, #3B82F6 100%);
        }

        .auth-box {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            display: flex;
            overflow: hidden;
        }

        .auth-welcome {
            flex: 1;
            background: linear-gradient(135deg, var(--primary) 0%, #1E3A8A 100%);
            color: white;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-welcome h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .auth-welcome p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .auth-form-container {
            flex: 1;
            padding: 40px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--neutral);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo h1 {
            color: var(--primary);
            font-size: 2rem;
        }

        .auth-logo p {
            color: var(--neutral);
            font-size: 0.9rem;
        }

        .social-login {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .social-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .social-btn:hover {
            background-color: #f9fafb;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #eee;
        }

        .divider span {
            background-color: white;
            padding: 0 15px;
            color: var(--neutral);
            font-size: 0.9rem;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Botões */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #172554;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--neutral);
            color: var(--dark);
        }

        .btn-outline:hover {
            background-color: #f3f4f6;
        }

        .w-100 {
            width: 100%;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notificações */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background-color: #10B981;
        }

        .notification.error {
            background-color: #EF4444;
        }

        .notification.warning {
            background-color: #F59E0B;
        }

        .notification.info {
            background-color: #3B82F6;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .auth-box {
                flex-direction: column;
                max-width: 400px;
            }

            .auth-welcome {
                padding: 30px;
            }
            
            .auth-form-container {
                padding: 30px;
            }
        }

        @media (max-width: 480px) {
            .auth-form-container {
                padding: 20px 15px;
            }
            
            .social-login {
                flex-direction: column;
            }
        }

        .d-none {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Tela de Login/Cadastro -->
    <div id="authPage" class="auth-container">
        <div class="auth-box">
            <div class="auth-welcome">
                <h1>BIXXJURIS</h1>
                <p>Gestão simplificada de casos jurídicos</p>
                <p style="margin-top: 20px;">Soluções completas para advogados e escritórios de advocacia</p>
            </div>

            <div class="auth-form-container">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Entrar</button>
                    <button class="auth-tab" data-tab="register">Cadastrar</button>
                </div>

                <!-- Formulário de Login -->
                <form id="loginForm" class="auth-form active">
                    <div class="auth-logo">
                        <h1>BIXXJURIS</h1>
                        <p>Faça login na sua conta</p>
                    </div>

                    <div class="social-login">
                        <button type="button" class="social-btn" onclick="loginWithGoogle()">
                            <i class="fab fa-google"></i> Google
                        </button>
                        <button type="button" class="social-btn" onclick="loginWithFacebook()">
                            <i class="fab fa-facebook"></i> Facebook
                        </button>
                    </div>

                    <div class="divider">
                        <span>ou</span>
                    </div>

                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" required>
                    </div>

                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input type="password" id="password" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                        <span id="loginText">Entrar</span>
                        <div class="loading d-none" id="loginLoading"></div>
                    </button>
                </form>

                <!-- Formulário de Cadastro -->
                <form id="registerForm" class="auth-form">
                    <div class="auth-logo">
                        <h1>BIXXJURIS</h1>
                        <p>Crie sua conta</p>
                    </div>

                    <div class="form-group">
                        <label for="registerCpf">CPF</label>
                        <input type="text" id="registerCpf" required maxlength="14" placeholder="000.000.000-00">
                    </div>

                    <div class="form-group">
                        <label for="registerEmail">E-mail</label>
                        <input type="email" id="registerEmail" required>
                    </div>

                    <div class="form-group">
                        <label for="registerName">Nome Completo</label>
                        <input type="text" id="registerName" required>
                    </div>

                    <div class="form-group">
                        <label for="registerPhone">Telefone Celular</label>
                        <input type="tel" id="registerPhone" required placeholder="(11) 99999-9999">
                    </div>

                    <div class="form-group">
                        <label for="registerPassword">Senha</label>
                        <input type="password" id="registerPassword" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirmar Senha</label>
                        <input type="password" id="registerConfirmPassword" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="registerBtn">
                        <span id="registerText">Criar Conta</span>
                        <div class="loading d-none" id="registerLoading"></div>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Dados globais
        let currentUser = null;

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar eventos
            setupEventListeners();

            // Configurar máscaras de entrada
            setupInputMasks();

            // Verificar estado de autenticação
            if (window.firebase) {
                const { onAuthStateChanged } = window.firebase.auth;
                onAuthStateChanged(window.firebase.auth.getAuth(), (user) => {
                    if (user) {
                        currentUser = user;
                        // Redirecionar para o dashboard
                        window.location.href = 'dashboard.html';
                    }
                });
            }
        });

        // Configurar máscaras de entrada
        function setupInputMasks() {
            const cpfInput = document.getElementById('registerCpf');
            const phoneInput = document.getElementById('registerPhone');

            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                        e.target.value = value;
                    }
                });
            }

            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/(\d{2})(\d)/, '($1) $2');
                        value = value.replace(/(\d{5})(\d)/, '$1-$2');
                        e.target.value = value;
                    }
                });
            }
        }

        // Configurar eventos
        function setupEventListeners() {
            // Tabs de autenticação
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchAuthTab(tabName);
                });
            });

            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        // Alternar entre abas de autenticação
        function switchAuthTab(tabName) {
            // Atualizar tabs ativas
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName);
            });

            // Mostrar formulário correspondente
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.toggle('active', form.id === tabName + 'Form');
            });
        }

        // Verificar se Firebase está carregado
        function checkFirebaseLoaded() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 10;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (window.firebase && window.firebase.auth) {
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Firebase não carregou após ' + maxAttempts + ' tentativas'));
                    }
                }, 500);
            });
        }

        // Manipular login
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginLoading = document.getElementById('loginLoading');

            try {
                // Aguardar Firebase carregar se necessário
                await checkFirebaseLoaded();

                // Mostrar loading
                loginText.classList.add('d-none');
                loginLoading.classList.remove('d-none');
                loginBtn.disabled = true;

                const { signInWithEmailAndPassword } = window.firebase.auth;
                await signInWithEmailAndPassword(window.firebase.auth.getAuth(), email, password);
                
                // O onAuthStateChanged irá redirecionar para o dashboard
            } catch (error) {
                console.error('Erro no login:', error);
                let errorMessage = 'Erro ao fazer login. Tente novamente.';
                
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'E-mail inválido.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Usuário não encontrado.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Senha incorreta.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Muitas tentativas. Tente novamente mais tarde.';
                        break;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                // Restaurar botão
                loginText.classList.remove('d-none');
                loginLoading.classList.add('d-none');
                loginBtn.disabled = false;
            }
        }

        // Manipular registro
        async function handleRegister(e) {
            e.preventDefault();

            const cpf = document.getElementById('registerCpf').value.replace(/\D/g, '');
            const email = document.getElementById('registerEmail').value;
            const name = document.getElementById('registerName').value;
            const phone = document.getElementById('registerPhone').value.replace(/\D/g, '');
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            // Validações locais
            if (cpf.length !== 11) {
                showNotification('CPF inválido! Digite um CPF válido com 11 dígitos.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('As senhas não coincidem!', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('A senha deve ter pelo menos 6 caracteres!', 'error');
                return;
            }

            if (phone.length < 10) {
                showNotification('Telefone inválido! Digite um número válido.', 'error');
                return;
            }

            const registerBtn = document.getElementById('registerBtn');
            const registerText = document.getElementById('registerText');
            const registerLoading = document.getElementById('registerLoading');

            try {
                // Aguardar Firebase carregar se necessário
                await checkFirebaseLoaded();

                // Mostrar loading
                registerText.classList.add('d-none');
                registerLoading.classList.remove('d-none');
                registerBtn.disabled = true;

                const { createUserWithEmailAndPassword, updateProfile } = window.firebase.auth;
                const userCredential = await createUserWithEmailAndPassword(
                    window.firebase.auth.getAuth(), 
                    email, 
                    password
                );

                // Atualizar perfil no Auth
                await updateProfile(userCredential.user, {
                    displayName: name
                });

                // Salvar no Firestore
                const userFirestoreData = {
                    cpf: cpf,
                    name: name,
                    email: email,
                    phone: phone,
                    cases: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const { doc, setDoc } = window.firebase.firestore;
                const db = window.firebase.firestore.getFirestore();

                await setDoc(doc(db, 'users', userCredential.user.uid), userFirestoreData);
                console.log('Usuário salvo no Firestore:', userCredential.user.uid);

                // Limpar formulário
                document.getElementById('registerForm').reset();

                showNotification('Cadastro realizado com sucesso! Você já pode fazer login.', 'success');
                
                // Mudar para login
                setTimeout(() => {
                    switchAuthTab('login');
                }, 2000);

            } catch (error) {
                console.error('Erro no registro:', error);
                let errorMessage = 'Erro ao criar conta. Tente novamente.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este e-mail já está em uso.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'E-mail inválido.';
                        break;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                // Restaurar botão
                registerText.classList.remove('d-none');
                registerLoading.classList.add('d-none');
                registerBtn.disabled = false;
            }
        }

        // Login com Google
        async function loginWithGoogle() {
            try {
                await checkFirebaseLoaded();
                
                const { GoogleAuthProvider, signInWithPopup } = window.firebase.auth;
                const provider = new GoogleAuthProvider();
                await signInWithPopup(window.firebase.auth.getAuth(), provider);
                
                // O onAuthStateChanged irá redirecionar para o dashboard
            } catch (error) {
                console.error('Erro no login com Google:', error);
                showNotification('Erro ao fazer login com Google. Tente novamente.', 'error');
            }
        }

        // Login com Facebook
        async function loginWithFacebook() {
            try {
                await checkFirebaseLoaded();
                
                const { FacebookAuthProvider, signInWithPopup } = window.firebase.auth;
                const provider = new FacebookAuthProvider();
                await signInWithPopup(window.firebase.auth.getAuth(), provider);
                
                // O onAuthStateChanged irá redirecionar para o dashboard
            } catch (error) {
                console.error('Erro no login com Facebook:', error);
                showNotification('Erro ao fazer login com Facebook. Tente novamente.', 'error');
            }
        }

        // Mostrar notificação
        function showNotification(message, type = 'info') {
            const existingNotification = document.getElementById('customNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'customNotification';
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
    </script>
</body>
</html>
